---
import CerrarSesion from "@components/CerrarSesion.astro";
import { verificarSesion } from "@utils/usuario";


let usuario = await verificarSesion(Astro.request);
// Detectar proyecto seleccionado por query string
const url = new URL(Astro.request.url);
const proyectoSeleccionadoID = url.searchParams.get("proyectoID");
const usuarioInicial = usuario.nombre ? usuario.nombre.charAt(0).toUpperCase() : usuario.email.charAt(0).toUpperCase();

const pathname = url.pathname + url.search;


const MenuProyecto = [
    {
        icono: `<path d="M240-200h120v-240h240v240h120v-360L480-740 240-560v360Zm-80 80v-480l320-240 320 240v480H520v-240h-80v240H160Zm320-350Z"/>`,
        texto: "Resumen",
        enlace: `/panel?proyectoID=${proyectoSeleccionadoID}`
    },
    {
        icono: `<path d="M440-280H280q-83 0-141.5-58.5T80-480q0-83 58.5-141.5T280-680h160v80H280q-50 0-85 35t-35 85q0 50 35 85t85 35h160v80ZM320-440v-80h320v80H320Zm200 160v-80h160q50 0 85-35t35-85q0-50-35-85t-85-35H520v-80h160q83 0 141.5 58.5T880-480q0 83-58.5 141.5T680-280H520Z"/>`,
        texto: "Web y URLs",
        enlace: `/panel/urls?proyectoID=${proyectoSeleccionadoID}`
    },
    {
        icono: `<path d="M280-160v-441q0-33 24-56t57-23h439q33 0 56.5 23.5T880-600v320L680-80H360q-33 0-56.5-23.5T280-160ZM81-710q-6-33 13-59.5t52-32.5l434-77q33-6 59.5 13t32.5 52l10 54h-82l-7-40-433 77 40 226v279q-16-9-27.5-24T158-276L81-710Zm279 110v440h280v-160h160v-280H360Zm220 220Z"/>`,
        texto: "Servicios",
        enlace: `/panel/servicios?proyectoID=${proyectoSeleccionadoID}`
    },
    {
        icono: `<path d="M120-120v-80l80-80v160h-80Zm160 0v-240l80-80v320h-80Zm160 0v-320l80 81v239h-80Zm160 0v-239l80-80v319h-80Zm160 0v-400l80-80v480h-80ZM120-327v-113l280-280 160 160 280-280v113L560-447 400-607 120-327Z"/>`,
        texto: `Estadísticas`,
        enlace: `/panel/estadisticas?proyectoID=${proyectoSeleccionadoID}`
    },
    {
        icono: `<path d="M240-80q-50 0-85-35t-35-85v-120h120v-560l60 60 60-60 60 60 60-60 60 60 60-60 60 60 60-60 60 60 60-60v680q0 50-35 85t-85 35H240Zm480-80q17 0 28.5-11.5T760-200v-560H320v440h360v120q0 17 11.5 28.5T720-160ZM360-600v-80h240v80H360Zm0 120v-80h240v80H360Zm320-120q-17 0-28.5-11.5T640-640q0-17 11.5-28.5T680-680q17 0 28.5 11.5T720-640q0 17-11.5 28.5T680-600Zm0 120q-17 0-28.5-11.5T640-520q0-17 11.5-28.5T680-560q17 0 28.5 11.5T720-520q0 17-11.5 28.5T680-480ZM240-160h360v-80H200v40q0 17 11.5 28.5T240-160Zm-40 0v-80 80Z"/>`,
        texto: "Facturas",
        enlace: `/panel/facturas?proyectoID=${proyectoSeleccionadoID}`
    },
    {
        icono: `<path d="m234-480-12-60q-12-5-22.5-10.5T178-564l-58 18-40-68 46-40q-2-13-2-26t2-26l-46-40 40-68 58 18q11-8 21.5-13.5T222-820l12-60h80l12 60q12 5 22.5 10.5T370-796l58-18 40 68-46 40q2 13 2 26t-2 26l46 40-40 68-58-18q-11 8-21.5 13.5T326-540l-12 60h-80Zm40-120q33 0 56.5-23.5T354-680q0-33-23.5-56.5T274-760q-33 0-56.5 23.5T194-680q0 33 23.5 56.5T274-600ZM592-40l-18-84q-17-6-31.5-14.5T514-158l-80 26-56-96 64-56q-2-18-2-36t2-36l-64-56 56-96 80 26q14-11 28.5-19.5T574-516l18-84h112l18 84q17 6 31.5 14.5T782-482l80-26 56 96-64 56q2 18 2 36t-2 36l64 56-56 96-80-26q-14 11-28.5 19.5T722-124l-18 84H592Zm56-160q50 0 85-35t35-85q0-50-35-85t-85-35q-50 0-85 35t-35 85q0 50 35 85t85 35Z"/>`,
        texto: "Ajustes",
        enlace: `/panel/ajustes?proyectoID=${proyectoSeleccionadoID}`
    }
]

const MenuGeneral = [
    {
        icono: `<path d="M240-200h120v-240h240v240h120v-360L480-740 240-560v360Zm-80 80v-480l320-240 320 240v480H520v-240h-80v240H160Zm320-350Z"/>`,
        texto: "Resumen General",
        enlace: "/panel"
    },
    {
        icono: `<path d="M240-80q-50 0-85-35t-35-85v-120h120v-560l60 60 60-60 60 60 60-60 60 60 60-60 60 60 60-60 60 60 60-60v680q0 50-35 85t-85 35H240Zm480-80q17 0 28.5-11.5T760-200v-560H320v440h360v120q0 17 11.5 28.5T720-160ZM360-600v-80h240v80H360Zm0 120v-80h240v80H360Zm320-120q-17 0-28.5-11.5T640-640q0-17 11.5-28.5T680-680q17 0 28.5 11.5T720-640q0 17-11.5 28.5T680-600Zm0 120q-17 0-28.5-11.5T640-520q0-17 11.5-28.5T680-560q17 0 28.5 11.5T720-520q0 17-11.5 28.5T680-480ZM240-160h360v-80H200v40q0 17 11.5 28.5T240-160Zm-40 0v-80 80Z"/>`,
        texto: `Facturas`,
        enlace: `/panel/facturas`
    }
]
---
<div class="w-60 h-full grid grid-rows-[1fr_auto] border-r-[1px] border-magenta ">
<header>
    {
        proyectoSeleccionadoID ? (
            <>
                <nav class="flex flex-col gap-y-2">
                    {
                        MenuProyecto.map(item => (
                            <a href={item.enlace} class={`flex flex-row items-center gap-x-3 w-52 mx-auto rounded-full h-auto p-3 hover:bg-rosa/40 hover:text-blanco duration-200 cursor-pointer ${pathname === item.enlace ? 'bg-magenta/40 text-blanco pointer-events-none' : ''}`}>
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 -960 960 960" fill="currentColor" set:html={item.icono}></svg>
                                <p>{item.texto}</p>
                            </a>
                        ))
                    }
                </nav>
            </>
        ) : (
            <>
            <nav class="flex flex-col gap-y-2">
                {
                    MenuGeneral.map(item => (
                        <a href={item.enlace} class={`flex flex-row items-center gap-x-3 w-52 mx-auto rounded-full h-auto p-3 hover:bg-rosa/40 hover:text-blanco duration-200 cursor-pointer ${pathname === item.enlace ? 'bg-magenta/40 text-blanco pointer-events-none' : ''}`}>
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 -960 960 960" fill="currentColor" set:html={item.icono}></svg>
                            <p>{item.texto}</p>
                        </a>
                    ))
                }
            </nav>
            </>
        )
    }
</header>
<div class="w-56 relative mx-auto flex flex-row items-center gap-x-3  border-[1px] rounded-full px-3 py-1 border-magenta select-none cursor-pointer">
    <span class="w-6 h-6 rounded-full fondo-perfil flex items-center place-content-center font-semibold text-black">{usuarioInicial}</span>
    <p id="btn-usuario" class="w-40 salto-de-linea">{usuario.email}</p>

    <div id="menu-usuario" class="absolute -top-24 flex-col gap-y-2 bg-azul border-[1px] border-magenta rounded-md shadow-lg w-48 h-auto p-3 hidden" id="perfilDropdown">
        <a class="flex flex-row text-base gap-x-2 items-center  hover:text-rosa hover:fill-rosa duration-300" href="/panel/perfil">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 -960 960 960">
                <path d="M234-276q51-39 114-61.5T480-360q69 0 132 22.5T726-276q35-41 54.5-93T800-480q0-133-93.5-226.5T480-800q-133 0-226.5 93.5T160-480q0 59 19.5 111t54.5 93Zm246-164q-59 0-99.5-40.5T340-580q0-59 40.5-99.5T480-720q59 0 99.5 40.5T620-580q0 59-40.5 99.5T480-440Zm0 360q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q53 0 100-15.5t86-44.5q-39-29-86-44.5T480-280q-53 0-100 15.5T294-220q39 29 86 44.5T480-160Zm0-360q26 0 43-17t17-43q0-26-17-43t-43-17q-26 0-43 17t-17 43q0 26 17 43t43 17Zm0-60Zm0 360Z"/>
            </svg>
            Mi Perfil
        </a>
        <CerrarSesion />
    </div>
</div>
</div>

<script>
    const btnUsuario = document.getElementById('btn-usuario')!;
    const menuUsuario = document.getElementById('menu-usuario')!;

    btnUsuario.addEventListener('click', () => {
        if (menuUsuario.classList.contains('hidden')) {
            menuUsuario.classList.remove('hidden');
            menuUsuario.classList.add('flex');
        } else {
            menuUsuario.classList.add('hidden');
            menuUsuario.classList.remove('flex');
        }
    });

    // Cerrar el menú al hacer clic fuera de él
    document.addEventListener('click', (event) => {
        if (!btnUsuario.contains(event.target as Node) && !menuUsuario.contains(event.target as Node)) {
            menuUsuario.classList.add('hidden');
            menuUsuario.classList.remove('flex');
        }
    });
</script>
<style>
    .salto-de-linea {
        white-space: nowrap;       /* No permite saltos de línea */
        overflow: hidden;          /* Oculta el texto que se desborda */
        text-overflow: ellipsis;   /* Muestra los puntos suspensivos */
    }

    .fondo-perfil{
background: #FB8AD7;
background: linear-gradient(45deg, rgba(251, 138, 215, 1) 0%, rgba(194, 58, 151, 1) 60%, rgba(194, 58, 151, 1) 100%);
    }
</style>
