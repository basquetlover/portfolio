---
import { verificarSesion } from "@utils/usuario";

const usuario = await verificarSesion(Astro.request);

import { proyectosUsuario } from "@utils/proyectoSeleccionado";

const proyectos = await proyectosUsuario(Astro.request);

const url = new URL(Astro.request.url);
const proyectoSeleccionadoID = url.searchParams.get("proyectoID");
function formatearFechaES(
    fecha: string | Date | null | undefined
    ): string {
    if (!fecha) return "";

    const date = fecha instanceof Date ? fecha : new Date(fecha);
    if (isNaN(date.getTime())) return "";

    const meses = [
        "ene", "feb", "mar", "abr", "may", "jun",
        "jul", "ago", "sep", "oct", "nov", "dic"
    ];

    const dia = date.getDate();
    const mes = meses[date.getMonth()];
    const año = date.getFullYear();

    return `${dia} ${mes} ${año}`;
}

type ProyectoUrl = {
    url: string;
    principal: boolean;
};

type Proyecto = {
    id: string;
    nombre: string;
    favicon: string;
    tipo_web: { tipo: string }[];
    estado: string;
    urls: ProyectoUrl[];
    plan: any[];
    rolUsuario: string;
    actualizado_en: string | Date | null;
    created_at: string | Date | null;
    tipo_proyecto?: string;
};
---
    <h1 class="text-4xl font-bold text-center mt-10">Panel de Administración</h1>
    <p class="text-center mt-4">Bienvenido <span class="text-magenta">{usuario.nombre}</span> al panel de administración de tus proyectos.</p>
    <h2 class="font-bold text-4xl ml-4 text-magenta mt-10">Proyectos</h2>
    <div class="w-full p-5 flex flex-wrap gap-6  ">
            {proyectos.map((p: Proyecto) => (
                <div class="w-96 relative h-52 overflow-hidden border border-blanco p-2 rounded hover:shadow-md hover:shadow-rosa hover:scale-105 hover:border-rosa duration-300">
                    {
                        p.tipo_proyecto === "demo" && (
                            <div class="absolute top-2 -right-8 rotate-45 uppercase text-blanco px-2 py-1 w-28 text-center texto-sm  bg-magenta">
                                {p.tipo_proyecto}
                            </div>
                        )
                    }
                <a href={`/panel?proyectoID=${p.id}`} class="w-full h-full">
                    <div class="w-full grid grid-cols-[auto_1fr] items-center ">
                        <img src={p.favicon} alt={`${p.nombre} favicon`} class="w-14 h-14"/>
                        <div>
                            <h4 class="text-2xl text-magenta font-semibold">{p.nombre}</h4>
                            {p.tipo_web && p.tipo_web.length > 0 && (
                            <span class="text-base text-rosa font-medium">
                                {p.tipo_web.map(({ tipo }: { tipo: string }) => tipo).join(" + ")}
                            </span>
                            )}
                        </div>
                        
                    </div>
                    <div class="w-max flex flex-row items-center place-content-center gap-x-1 mx-1 mt-2 capitalize">
                        <p class={`flex flex-row items-center place-content-center gap-x-1 ${p.estado === "En Producción" ? 'text-green-600':''} ${p.estado === "En Desarrollo" ? 'text-orange-600':''}`}><span class={`w-[6px] h-[6px] inline-block rounded-full ${p.estado === "En Producción" ? 'bg-green-600':''} ${p.estado === "En Desarrollo" ? 'bg-orange-600':''}`}>&nbsp;</span>{p.estado}</p>
                        <span>|</span>
                        <p>
                            Última actualización: {p.actualizado_en ? formatearFechaES(p.actualizado_en) : formatearFechaES(p.created_at)}
                        </p>
                    </div>
                    <div class="w-full mt-4 grid grid-cols-3 place-items-center ">
                        {/* Dominios */}
                        <div class="w-20 h-20 rounded border border-rosa flex flex-col place-content-center items-center">
                            
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 -960 960 960">
                                    <path d="M480-80q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q134 0 227-93t93-227q0-7-.5-14.5T799-507q-5 29-27 48t-52 19h-80q-33 0-56.5-23.5T560-520v-40H400v-80q0-33 23.5-56.5T480-720h40q0-23 12.5-40.5T563-789q-20-5-40.5-8t-42.5-3q-134 0-227 93t-93 227h200q66 0 113 47t47 113v40H400v110q20 5 39.5 7.5T480-160Z"/>
                                </svg>
                            
                            <p class="text-sm">Dominios</p>
                            <p class="text-xl font-semibold">{p.urls?.length || 0}</p>
                        </div>
                        {/* Servicios */}
                        <div class="w-20 h-20 rounded border border-rosa flex flex-col place-content-center items-center">
                            
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 -960 960 960">
                                    <path d="M280-160v-441q0-33 24-56t57-23h439q33 0 56.5 23.5T880-600v320L680-80H360q-33 0-56.5-23.5T280-160ZM81-710q-6-33 13-59.5t52-32.5l434-77q33-6 59.5 13t32.5 52l10 54h-82l-7-40-433 77 40 226v279q-16-9-27.5-24T158-276L81-710Zm279 110v440h280v-160h160v-280H360Zm220 220Z"/>
                                </svg>
                            
                            <p class="text-sm">Servicios</p>
                            <p class="text-xl font-semibold">{p.plan?.length || 0}</p>
                        </div>
                        {/* Rol */}
                        <div class={`w-20 h-20 p-1 rounded border flex flex-col place-content-center items-center ${p.rolUsuario === 'propietario' ? 'bg-rol-propietario/30 border-rol-propietario text-rol-propietario' : p.rolUsuario === 'admin' ? 'bg-rol-administracion/30 border-rol-administracion text-rol-administracion' : p.rolUsuario === 'visitante' ? 'bg-rol-visitante/30 border-rol-visitante text-rol-visitante' : 'bg-rol-colaborador/30 text-rol-colaborador border-rol-colaborador'}`}>
                            
                                {
                                    p.rolUsuario === 'propietario' ? (
                                        <svg xmlns="http://www.w3.org/2000/svg" class="w-7 h-7 fill-rol-propietario" viewBox="0 -960 960 960">
                                            <path d="M200-160v-80h560v80H200Zm0-140-51-321q-2 0-4.5.5t-4.5.5q-25 0-42.5-17.5T80-680q0-25 17.5-42.5T140-740q25 0 42.5 17.5T200-680q0 7-1.5 13t-3.5 11l125 56 125-171q-11-8-18-21t-7-28q0-25 17.5-42.5T480-880q25 0 42.5 17.5T540-820q0 15-7 28t-18 21l125 171 125-56q-2-5-3.5-11t-1.5-13q0-25 17.5-42.5T820-740q25 0 42.5 17.5T880-680q0 25-17.5 42.5T820-620q-2 0-4.5-.5t-4.5-.5l-51 321H200Zm68-80h424l26-167-105 46-133-183-133 183-105-46 26 167Zm212 0Z"/>
                                        </svg>
                                    ) : p.rolUsuario === 'admin' ? (
                                        <svg xmlns="http://www.w3.org/2000/svg" class="w-7 h-7 fill-rol-administracion" viewBox="0 -960 960 960">
                                            <path d="M480-440q-59 0-99.5-40.5T340-580q0-59 40.5-99.5T480-720q59 0 99.5 40.5T620-580q0 59-40.5 99.5T480-440Zm0-80q26 0 43-17t17-43q0-26-17-43t-43-17q-26 0-43 17t-17 43q0 26 17 43t43 17Zm0 440q-139-35-229.5-159.5T160-516v-244l320-120 320 120v244q0 152-90.5 276.5T480-80Zm0-400Zm0-315-240 90v189q0 54 15 105t41 96q42-21 88-33t96-12q50 0 96 12t88 33q26-45 41-96t15-105v-189l-240-90Zm0 515q-36 0-70 8t-65 22q29 30 63 52t72 34q38-12 72-34t63-52q-31-14-65-22t-70-8Z"/>
                                        </svg>
                                    ) : p.rolUsuario === 'visitante' ? (
                                        <svg xmlns="http://www.w3.org/2000/svg" class="w-7 h-7 fill-rol-visitante" viewBox="0 -960 960 960">
                                            <path d="M480-320q75 0 127.5-52.5T660-500q0-75-52.5-127.5T480-680q-75 0-127.5 52.5T300-500q0 75 52.5 127.5T480-320Zm0-72q-45 0-76.5-31.5T372-500q0-45 31.5-76.5T480-608q45 0 76.5 31.5T588-500q0 45-31.5 76.5T480-392Zm0 192q-146 0-266-81.5T40-500q54-137 174-218.5T480-800q146 0 266 81.5T920-500q-54 137-174 218.5T480-200Zm0-300Zm0 220q113 0 207.5-59.5T832-500q-50-101-144.5-160.5T480-720q-113 0-207.5 59.5T128-500q50 101 144.5 160.5T480-280Z"/>
                                        </svg>
                                    ) : (
                                        <svg xmlns="http://www.w3.org/2000/svg" class="w-7 h-7 fill-rol-colaborador" viewBox="0 -960 960 960">
                                            <path d="M0-240v-63q0-43 44-70t116-27q13 0 25 .5t23 2.5q-14 21-21 44t-7 48v65H0Zm240 0v-65q0-32 17.5-58.5T307-410q32-20 76.5-30t96.5-10q53 0 97.5 10t76.5 30q32 20 49 46.5t17 58.5v65H240Zm540 0v-65q0-26-6.5-49T754-397q11-2 22.5-2.5t23.5-.5q72 0 116 26.5t44 70.5v63H780Zm-455-80h311q-10-20-55.5-35T480-370q-55 0-100.5 15T325-320ZM160-440q-33 0-56.5-23.5T80-520q0-34 23.5-57t56.5-23q34 0 57 23t23 57q0 33-23 56.5T160-440Zm640 0q-33 0-56.5-23.5T720-520q0-34 23.5-57t56.5-23q34 0 57 23t23 57q0 33-23 56.5T800-440Zm-320-40q-50 0-85-35t-35-85q0-51 35-85.5t85-34.5q51 0 85.5 34.5T600-600q0 50-34.5 85T480-480Zm0-80q17 0 28.5-11.5T520-600q0-17-11.5-28.5T480-640q-17 0-28.5 11.5T440-600q0 17 11.5 28.5T480-560Zm1 240Zm-1-280Z"/>
                                        </svg>
                                    )
                                }
                            
                            <p class="text-sm capitalize">{p.rolUsuario}</p>
                            {/* <p class="text-xl font-semibold">{p.plan?.length || 0}</p> */}
                        </div>
                    </div>
                </a>
                </div>
            ))}
    </div>